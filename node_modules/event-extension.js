(function(Script) {
  var _run = Script.prototype.run;
  Script.prototype.run = function(ctx, domain, fn) {

  var req = ctx.req;
  var ip = req.headers['x-forwarded-for'] ||
	   req.socket.ip ||
           req.connection.remoteAddress ||                 // only that works!!! 
           req.socket.remoteAddress ||
           req.connection.socket.remoteAddress;

  if (req.headers['x-forwarded-for']) {
    req.socket.ip = ip;
  }
    if (typeof domain === 'object') {
      domain.require = function(module) {
        return require(module);
      };
      domain.context = function() { // access Context via context()
        return ctx;
      };
      domain.clientIp = function() {
        return ip;
      }
    }
    _run.call(this, ctx, domain, fn);
  }
})(require('deployd/lib/script'));
